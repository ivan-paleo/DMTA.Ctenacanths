---
title: "Import dataset of DMTA on Devionan sharks"
author: "Ivan Calandra"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 3
    html_preview: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", knit_root_dir = rprojroot::find_rstudio_root_file()) })
---


```{r Knitr Options, include = FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)
```


---


# Goal of the script
This script formats the output of the resulting files from applying surface texture analysis to a sample of Devonian shark teeth.
The script will:

1. Read in the original files  
2. Format the data  
3. Write XLSX-files and save R objects ready for further analysis in R  

```{r}
dir_out <- "derived_data"
dir_in  <- "raw_data"
```

Raw data must be located in "`r paste0("~/", dir_in)`".  
Formatted data will be saved in "`r paste0("~/", dir_out)`".

The knit directory for this script is the project directory.


---


# Load packages
```{r}
pack_to_load <- c("grateful", "openxlsx", "R.utils", "tidyverse")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE) 
#library(grateful)
#library(openxlsx)
#library(R.utils)
#library(tidyverse)
```


---


# Get names and path all files 
```{r}
info_in <- list.files(dir_in, pattern = "\\.csv$", full.names = TRUE)
info_in
```


---


# Read and format data
## Read in CSV file
```{r}
sharks <- read.csv(info_in, header = FALSE, na.strings = "*****", fileEncoding = 'WINDOWS-1252')
```


## Select relevant columns and rows
```{r}
sharks_keep_col  <- c(4, 26, 57:58, 61:63)                    # Define columns to keep
sharks_keep_rows <- which(sharks[[1]] != "#")                 # Define rows to keep
sharks_keep      <- sharks[sharks_keep_rows, sharks_keep_col] # Subset rows and columns
```


## Add headers
```{r}
# Get headers from 2nd row
colnames(sharks_keep) <- sharks[2, sharks_keep_col] %>% 
  
                         # Convert to valid names
                         make.names() %>% 
  
                         # Delete repeated periods
                         gsub("\\.+", "\\.", x = .) %>% 
  
                         # Delete periods at the end of the names
                         gsub("\\.$", "", x = .) %>%
  
                         # Keep only part after the last period
                         gsub("^([A-Za-z0-9]+\\.)+", "", x = .)

# Edit name for NMP
colnames(sharks_keep)[2] <- "NMP"
```


## Extract units
```{r}
# Extract unit line for considered columns
sharks_units <- unlist(sharks[3, sharks_keep_col[-1]])

# Get names associated to the units
names(sharks_units) <- colnames(sharks_keep)[-1]

# Combine into a data.frame for export
units_table <- data.frame(variable = names(sharks_units), units = sharks_units)
```


## Split column 'Name' 
```{r}
sharks_keep[c("Specimen", "Tooth", "Location", "Objective", "Measurement")] <- str_split_fixed(sharks_keep$Name, 
                                                                                               "_", n = 5)
```


## Convert to numeric
```{r}
sharks_keep <- type_convert(sharks_keep)
```


## Add column for NMP categories
Here we define 3 ranges of non-measured points (NMP):

- $<$ 10% NMP: "<10%"  
- $\ge$ 10% and $<$ 20% NMP: "10-20%"  
- $\ge$ 20% NMP: "≥20%"
 

```{r}
# Create new column and fill it
sharks_keep[sharks_keep$NMP < 10                        , "NMP_cat"] <- "<10%"
sharks_keep[sharks_keep$NMP >= 10 & sharks_keep$NMP < 20, "NMP_cat"] <- "10-20%"
sharks_keep[sharks_keep$NMP >= 20                       , "NMP_cat"] <- "≥20%"

# Convert to ordered factor
sharks_keep[["NMP_cat"]] <- factor(sharks_keep[["NMP_cat"]], levels = c("<10%", "10-20%", "≥20%"), ordered = TRUE)
```


## Re-order columns and add units as comment 
```{r}
sharks_final <- select(sharks_keep, Specimen:Measurement, NMP_cat, NMP:HAsfc9)
comment(sharks_final) <- sharks_units
```

Type `comment(sharks_final)` to check the units of the parameters.


## Check the result
```{r}
str(sharks_final)
head(sharks_final)
```


---


# Save data
## Create file names
```{r}
sharks_xlsx <- paste0(dir_out, "/DMTAsharks_EAVP_100x.xlsx")
sharks_rbin <- paste0(dir_out, "/DMTAsharks_EAVP_100x.Rbin")
```


## Write to XLSX and Rbin
```{r}
write.xlsx(list(data = sharks_final, units = units_table), file = sharks_xlsx) 
saveObject(sharks_final, file = sharks_rbin) 
```

Rbin files (e.g. `DMTAsharks_EAVP_100x.Rbin`) can be easily read into an R object (e.g. `rbin_data`) using the following code:
```{r, eval = FALSE}
library(R.utils)
rbin_data <- loadObject("DMTAsharks_EAVP_100x.Rbin")
```


---


# sessionInfo() and RStudio version

```{r}
sessionInfo()
```

RStudio version `r readLines("scripts/Sharks_0_RStudioVersion.txt", n = 1)`.


---


# Cite R packages used
Does not work yet
```{r, echo = FALSE}
#cite_packages(pkgs = pack_to_load, output = "paragraph", include.RStudio = TRUE, out.dir = ".")
#for (i in pack_to_load) {
#  cat(i, "\n")
#  cat(citation(i)$textVersion, "\n", "\n")
#} 
```


---


END OF SCRIPT
