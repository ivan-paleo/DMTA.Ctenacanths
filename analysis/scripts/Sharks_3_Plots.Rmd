---
title: "Plots for the dataset of DMTA on Devionan sharks"
author: "Ivan Calandra"
date: "`r format(Sys.time(), usetz = TRUE)`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 3
    html_preview: false
bibliography: Sharks_3_Plots.bib
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", knit_root_dir = rprojroot::find_rstudio_root_file()) })
---

```{r Knitr Options, include = FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)
```


---


# Goal of the script
The script plots all SSFA variables for the Devonian shark dataset.   

```{r}
dir_in  <- "analysis/derived_data"
dir_out <- "analysis/plots"
```

Input Rbin data file must be located in "`r paste0("./", dir_in)`".  
Plots will be saved in "`r paste0("./", dir_out)`".

The knit directory for this script is the project directory.


---


# Load packages
```{r}
pack_to_load <- c("factoextra", "ggplot2", "ggpubr", "grateful", "knitr", 
                  "R.utils", "RColorBrewer", "rmarkdown", "tidyverse")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE)
```


---


# Read in data
## Get name and path of input file 
```{r}
info_in <- list.files(dir_in, pattern = "\\.Rbin$", full.names = TRUE)
info_in
```


## Read in Rbin file
```{r}
sharks <- loadObject(info_in)
str(sharks)
```


---


# Exclude surfaces with NMP ≥ 20%
Surfaces with more than 20% NMP should not be analyzed.

```{r}
sharks_nmp0_20 <- filter(sharks, NMP_cat != "≥20%")
sharks_nmp0_20$NMP_cat <- factor(sharks_nmp0_20$NMP_cat)
str(sharks_nmp0_20)
```


---


# Plot each surface parameter in a boxplot
## Define variables
Here we define which columns are used for the boxplots.  

```{r}
# Column to be used to group on the x-axis
x_var <- "Specimen"

# Columns to be used on the y-axis
y_ISO_height <- colnames(sharks)[8:14] 
y_ISO_vol <- colnames(sharks)[24:29] 
y_ISO_others <- colnames(sharks)[15:23] 
y_furrow_diriso <- colnames(sharks)[30:36]
y_SSFA <- colnames(sharks)[37:42]

# colors
grp_colors <- "Tooth"

# shapes
grp_shapes <- "NMP_cat"
```


## Plotting function
```{r}
custom_boxplot <- function(dat, x_axis = x_var, y_axis = "Value", 
                           group_col = grp_colors, group_shape = grp_shapes, 
                           facet_var = "Parameter"){
  
  # Define aesthetics
  p_out <- ggplot(dat, aes(x = .data[[x_axis]], y = .data[[y_axis]])) +

           # Boxplots:
           # hide outliers (all points are shown with geom_point() below) 
           geom_boxplot(outlier.shape = NA) +
  
           # Points:
           # Add layers of shapes and colors for points 
           # Jitter points
           geom_point(mapping = aes(shape = .data[[group_shape]], color = .data[[group_col]]), 
                      position = "jitter", size = 3, alpha = 0.7) +
    
           # Wrap around parameters (i.e. 1 subplot per parameter) with free y-scales
           facet_wrap(as.formula(paste0("~", facet_var)), scales = "free_y") +
  
           # Remove x- and y-axis labels
           labs(x = NULL, y = NULL) + 
  
           # Choose a light theme
           theme_classic() +
  
           # The qualitative 'Set2' palette of RColorBrewer is colorblind friendly
           scale_color_brewer(palette = 'Set2')

  # Return ggplot object
  return(p_out)
}
```


## Plot
### ISO 25178 height parameters
```{r}
# Subset and pivot to longer format for facet plots
ISO_height_long <- select(sharks_nmp0_20, all_of(c(x_var, y_ISO_height, grp_colors, grp_shapes))) %>%
                   pivot_longer(all_of(y_ISO_height), names_to = "Parameter", values_to = "Value")
str(ISO_height_long)
head(ISO_height_long)

# Define plot
p_ISO_height <- custom_boxplot(dat = ISO_height_long)

# Print plot
print(p_ISO_height)
```

### ISO 25178 volume parameters
```{r}
ISO_vol_long <- select(sharks_nmp0_20, all_of(c(x_var, y_ISO_vol, grp_colors, grp_shapes))) %>%
                pivot_longer(all_of(y_ISO_vol), names_to = "Parameter", values_to = "Value")

p_ISO_vol <- custom_boxplot(dat = ISO_vol_long)
print(p_ISO_vol)
```

### Other ISO 25178 parameters
```{r}
ISO_others_long <- select(sharks_nmp0_20, all_of(c(x_var, y_ISO_others, grp_colors, grp_shapes))) %>%
                   pivot_longer(all_of(y_ISO_others), names_to = "Parameter", values_to = "Value")

p_ISO_others <- custom_boxplot(dat = ISO_others_long)
print(p_ISO_others)
```

### Furrow, direction and isotropy parameters 
```{r}
furrow_diriso_long <- select(sharks_nmp0_20, all_of(c(x_var, y_furrow_diriso, grp_colors, grp_shapes))) %>%
                      pivot_longer(all_of(y_furrow_diriso), names_to = "Parameter", values_to = "Value")

p_furrow_diriso <- custom_boxplot(dat = furrow_diriso_long)
print(p_furrow_diriso)
```

### SSFA parameters 
```{r}
ssfa_long <- select(sharks_nmp0_20, all_of(c(x_var, y_SSFA, grp_colors, grp_shapes))) %>%
                    pivot_longer(all_of(y_SSFA), names_to = "Parameter", values_to = "Value")

p_ssfa_long <- custom_boxplot(dat = ssfa_long)
print(p_ssfa_long)
```


## Save plots
```{r}
ggexport(plotlist = list(p_ISO_height, p_ISO_vol, p_ISO_others, p_furrow_diriso, p_ssfa_long), 
         filename = paste0(dir_out, "/DMTA-Ctenacanths_boxplots.pdf"))
```


---


# Plot anisotropy vs. complexity
## Plot
```{r}
# set up plot
p_bi <- ggplot(sharks_nmp0_20, aes(x = Asfc, y = epLsar)) +
        
        # Scatterplot
        geom_point(mapping = aes(color = .data[[grp_colors]], shape = .data[[grp_shapes]]), size = 4) +
  
        # Adjust axes labels
        labs(x = "Complexity (Asfc)", y = "Anisotropy (epLsar)") +
  
        # The qualitative 'Set2' palette of RColorBrewer is colorblind friendly
        scale_color_brewer(palette = 'Set2') +
  
        # Wrap around Specimen (i.e. 1 subplot per specimen)
        facet_wrap(~ Specimen) +
  
        # Choose a light theme
        theme_classic()

# Print plot
print(p_bi)
```


## Save plot
```{r}
ggexport(plotlist = list(p_bi), filename = paste0(dir_out, "/DMTA-Ctenacanths_epLsar-Asfc.pdf"))
```


---


# PCA
## Prepare data and select parameters
```{r}
# Remove rows with NA 
data_pca <- na.omit(sharks_nmp0_20)

# Convert grouping variables into factor()
data_pca[["Specimen"]] <- factor(data_pca[["Specimen"]])
data_pca[["Tooth"]] <- factor(data_pca[["Tooth"]])
str(data_pca)

# Select parameters to use in the PCA, based on previous plots
pca_params <- c("Sq", "Vmc", "Sal", "Sdr", "Str", 
                "First.direction", "Mean.density.of.furrows", "Mean.depth.of.furrows", 
                "Asfc", "epLsar", "HAsfc9")
```

## PCA of specimens (CC vs. MM)
```{r}
# PCA 
pca_spec <- prcomp(data_pca[ , pca_params], scale. = TRUE) 

# Visualize eigenvalues
pca_spec_eig <- fviz_eig(pca_spec, addlabels = TRUE, ggtheme = theme_classic(), 
                         title = "PCA Specimen - Eigenvalues")
print(pca_spec_eig)

# Biplot of PC1&2
pca_spec_12 <- fviz_pca_biplot(pca_spec, axes = c(1, 2), 
                               geom.ind = "point", col.ind = data_pca$Specimen, mean.point = FALSE,
                               palette = brewer.pal(3, "Set2")[1:2], pointsize = 3, 
                               addEllipses = TRUE, ellipse.type = "convex",  
                               repel = TRUE, col.var = "black", 
                               legend.title = "Specimen", title = "PCA Specimen - PC1&2")
print(pca_spec_12)

# Biplot of PC1&3
pca_spec_13 <- fviz_pca_biplot(pca_spec, axes = c(1, 3), 
                               geom.ind = "point", col.ind = data_pca$Specimen, mean.point = FALSE,
                               palette = brewer.pal(3, "Set2")[1:2], pointsize = 3, 
                               addEllipses = TRUE, ellipse.type = "convex",  
                               repel = TRUE, col.var = "black", 
                               legend.title = "Specimen", title = "PCA Specimen - PC1&3")
print(pca_spec_13)
```


## PCA of Teeth within CC 
```{r}
# Filter data on Specimen CC
data_pca_tooth <- filter(data_pca, Specimen == "CC")
str(data_pca_tooth)

# PCA 
pca_tooth <- prcomp(data_pca_tooth[ , pca_params], scale. = TRUE) 

# Visualize eigenvalues
pca_tooth_eig <- fviz_eig(pca_tooth, addlabels = TRUE, ggtheme = theme_classic(), 
                          title = "PCA Tooth - Eigenvalues")
print(pca_tooth_eig)

# Biplot of PC1&2
pca_tooth_12 <- fviz_pca_biplot(pca_tooth, axes = c(1, 2), 
                                geom.ind = "point", col.ind = data_pca_tooth$Tooth, 
                                fill.ind = data_pca_tooth$Tooth, mean.point = FALSE, 
                                palette = brewer.pal(7, "Set2"), pointsize = 3, pointshape = 21,
                                addEllipses = TRUE, ellipse.type = "convex",  
                                repel = TRUE, col.var = "black", 
                                legend.title = "Specimen", title = "PCA Tooth - PC1&2")
print(pca_tooth_12)

# Biplot of PC1&3
pca_tooth_13 <- fviz_pca_biplot(pca_tooth, axes = c(1, 3), 
                                geom.ind = "point", col.ind = data_pca_tooth$Tooth, 
                                fill.ind = data_pca_tooth$Tooth, mean.point = FALSE, 
                                palette = brewer.pal(7, "Set2"), pointsize = 3, pointshape = 21,
                                addEllipses = TRUE, ellipse.type = "convex",  
                                repel = TRUE, col.var = "black", 
                                legend.title = "Specimen", title = "PCA Tooth - PC1&3")
print(pca_tooth_13)
```


## Save plots
```{r}
ggexport(plotlist = list(pca_spec_eig, pca_spec_12, pca_spec_13, 
                         pca_tooth_eig, pca_tooth_12, pca_tooth_13), 
         filename = paste0(dir_out, "/DMTA-Ctenacanths_PCA.pdf"))
```


---


# sessionInfo()

```{r}
sessionInfo()
```


---


# Cite R packages used

```{r, echo = FALSE}
cite_packages(pkgs = c(pack_to_load, "base"), output = "paragraph", 
              include.RStudio = TRUE, out.dir = "analysis/scripts", bib.file = "Sharks_3_Plots")
```


## References

