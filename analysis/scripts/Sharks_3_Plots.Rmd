---
title: "Plots for the dataset of DMTA on Devionan sharks"
author: "Ivan Calandra"
date: "`r format(Sys.time(), usetz = TRUE)`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 4
    html_preview: false
bibliography: Sharks_3_Plots.bib
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", knit_root_dir = rprojroot::find_rstudio_root_file()) })
---

```{r Knitr Options, include = FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)
```


---


# Goal of the script
The script plots all SSFA variables for the Devonian shark dataset.   

```{r}
dir_in  <- "analysis/derived_data"
dir_out <- "analysis/plots"
```

Input Rbin data file must be located in "`r paste0("./", dir_in)`".  
Plots will be saved in "`r paste0("./", dir_out)`".

The knit directory for this script is the project directory.


---


# Load packages
```{r}
pack_to_load <- sort(c("R.utils", "tidyverse", "factoextra", "ggplot2", "ggpubr", "RColorBrewer", 
                       "knitr", "rmarkdown", "grateful"))
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE)
```


---


# Read in data
## Get name and path of input file 
```{r}
info_in <- list.files(dir_in, pattern = "\\.Rbin$", full.names = TRUE)
info_in
```


## Read in Rbin file
```{r}
sharks <- loadObject(info_in)
str(sharks)
```


---


# Exclude surfaces with NMP ≥ 20%
Surfaces with more than 20% NMP should not be analyzed.

```{r}
sharks_nmp0_20 <- filter(sharks, NMP_cat != "≥20%")
sharks_nmp0_20$NMP_cat <- factor(sharks_nmp0_20$NMP_cat)
str(sharks_nmp0_20)
```


---


# Plot each surface parameter in a boxplot
## Define variables
Here we define which columns are used for the boxplots.  

```{r}
# Columns to be used to group on the x-axis
x_sp <- "Specimen"
x_pos <- "Position"

# Columns to be used on the y-axis
y_ISO_height <- colnames(sharks)[9:15] 
y_ISO_vol <- colnames(sharks)[25:30] 
y_ISO_others <- colnames(sharks)[16:24] 
y_furrow_diriso <- colnames(sharks)[31:37]
y_SSFA <- colnames(sharks)[38:43]

# colors
grp_colors <- "Tooth"

# shapes
grp_shapes <- "NMP_cat"
```


## Plotting function
```{r}
custom_boxplot <- function(dat, x_axis, y_axis = "Value", 
                           group_col = grp_colors, group_shape = grp_shapes, 
                           facet_var = "Parameter"){
  
  # Define aesthetics
  p_out <- ggplot(dat, aes(x = .data[[x_axis]], y = .data[[y_axis]])) +

           # Boxplots:
           # hide outliers (all points are shown with geom_point() below) 
           geom_boxplot(outlier.shape = NA) +
  
           # Points:
           # Add layers of shapes and colors for points 
           # Jitter points
           geom_point(mapping = aes(shape = .data[[group_shape]], color = .data[[group_col]]), 
                      position = "jitter", size = 3, alpha = 0.7) +
    
           # Wrap around parameters (i.e. 1 subplot per parameter) with free y-scales
           facet_wrap(as.formula(paste0("~", facet_var)), scales = "free_y") +
  
           # Remove x- and y-axis labels
           labs(x = NULL, y = NULL) + 
  
           # Choose a light theme
           theme_classic() +
  
           # The qualitative 'Set2' palette of RColorBrewer is colorblind friendly
           scale_color_brewer(palette = 'Set2')

  # Return ggplot object
  return(p_out)
}
```


## Plot with Specimen as grouping variable
### ISO 25178 height parameters
```{r}
# Subset and pivot to longer format for facet plots
Sp_ISO_height_long <- select(sharks_nmp0_20, all_of(c(x_sp, y_ISO_height, grp_colors, grp_shapes))) %>%
                      pivot_longer(all_of(y_ISO_height), names_to = "Parameter", values_to = "Value")
str(Sp_ISO_height_long)
head(Sp_ISO_height_long)

# Define plot
Sp_p_ISO_height <- custom_boxplot(dat = Sp_ISO_height_long, x_axis = x_sp)

# Print plot
print(Sp_p_ISO_height)
```

### ISO 25178 volume parameters
```{r}
Sp_p_ISO_vol <- select(sharks_nmp0_20, all_of(c(x_sp, y_ISO_vol, grp_colors, grp_shapes))) %>%
                pivot_longer(all_of(y_ISO_vol), names_to = "Parameter", values_to = "Value") %>%
                custom_boxplot(dat = ., x_axis = x_sp)
print(Sp_p_ISO_vol)
```

### Other ISO 25178 parameters
```{r}
Sp_p_ISO_others <- select(sharks_nmp0_20, all_of(c(x_sp, y_ISO_others, grp_colors, grp_shapes))) %>%
                   pivot_longer(all_of(y_ISO_others), names_to = "Parameter", values_to = "Value") %>%
                   custom_boxplot(dat = ., x_axis = x_sp)
print(Sp_p_ISO_others)
```

### Furrow, direction and isotropy parameters 
```{r}
Sp_p_furrow_diriso <- select(sharks_nmp0_20, all_of(c(x_sp, y_furrow_diriso, grp_colors, grp_shapes))) %>%
                      pivot_longer(all_of(y_furrow_diriso), names_to = "Parameter", values_to = "Value") %>%
                      custom_boxplot(dat = ., x_axis = x_sp)
print(Sp_p_furrow_diriso)
```

### SSFA parameters 
```{r}
Sp_p_ssfa <- select(sharks_nmp0_20, all_of(c(x_sp, y_SSFA, grp_colors, grp_shapes))) %>%
             pivot_longer(all_of(y_SSFA), names_to = "Parameter", values_to = "Value") %>%
             custom_boxplot(dat = ., x_axis = x_sp)
print(Sp_p_ssfa)
```

### Save plots
```{r}
ggexport(plotlist = list(Sp_p_ISO_height, Sp_p_ISO_vol, Sp_p_ISO_others, Sp_p_furrow_diriso, Sp_p_ssfa), 
         filename = paste0(dir_out, "/DMTA-Ctenacanths_boxplots-", x_sp, ".pdf"))
```


## Plot with Position as grouping variable
### ISO 25178 height parameters
```{r}
# Subset and pivot to longer format for facet plots
Pos_ISO_height_long <- select(sharks_nmp0_20, all_of(c(x_pos, y_ISO_height, grp_colors, grp_shapes))) %>%
                       pivot_longer(all_of(y_ISO_height), names_to = "Parameter", values_to = "Value")
str(Pos_ISO_height_long)
head(Pos_ISO_height_long)

# Define plot
Pos_p_ISO_height <- custom_boxplot(dat = Pos_ISO_height_long, x_axis = x_pos)

# Print plot
print(Pos_p_ISO_height)
```

### ISO 25178 volume parameters
```{r}
Pos_p_ISO_vol <- select(sharks_nmp0_20, all_of(c(x_pos, y_ISO_vol, grp_colors, grp_shapes))) %>%
                 pivot_longer(all_of(y_ISO_vol), names_to = "Parameter", values_to = "Value") %>%
                 custom_boxplot(dat = ., x_axis = x_pos)
print(Pos_p_ISO_vol)
```

### Other ISO 25178 parameters
```{r}
Pos_p_ISO_others <- select(sharks_nmp0_20, all_of(c(x_pos, y_ISO_others, grp_colors, grp_shapes))) %>%
                    pivot_longer(all_of(y_ISO_others), names_to = "Parameter", values_to = "Value") %>%
                    custom_boxplot(dat = ., x_axis = x_pos)
print(Pos_p_ISO_others)
```

### Furrow, direction and isotropy parameters 
```{r}
Pos_p_furrow_diriso <- select(sharks_nmp0_20, all_of(c(x_pos, y_furrow_diriso, grp_colors, grp_shapes))) %>%
                       pivot_longer(all_of(y_furrow_diriso), names_to = "Parameter", values_to = "Value") %>%
                       custom_boxplot(dat = ., x_axis = x_pos)
print(Pos_p_furrow_diriso)
```

### SSFA parameters 
```{r}
Pos_p_ssfa <- select(sharks_nmp0_20, all_of(c(x_pos, y_SSFA, grp_colors, grp_shapes))) %>%
              pivot_longer(all_of(y_SSFA), names_to = "Parameter", values_to = "Value") %>%
              custom_boxplot(dat = ., x_axis = x_pos)
print(Pos_p_ssfa)
```

### Save plots
```{r}
ggexport(plotlist = list(Pos_p_ISO_height, Pos_p_ISO_vol, Pos_p_ISO_others, Pos_p_furrow_diriso, Pos_p_ssfa), 
         filename = paste0(dir_out, "/DMTA-Ctenacanths_boxplots-", x_pos, ".pdf"))
```


---


# Plot anisotropy vs. complexity
## Facetting around Specimen
```{r}
# set up plot
Sp_p_bi <- ggplot(sharks_nmp0_20, aes(x = Asfc, y = epLsar)) +
        
           # Scatterplot
           geom_point(mapping = aes(color = .data[[grp_colors]], shape = .data[[grp_shapes]]), size = 4) +
  
           # Adjust axes labels
           labs(x = "Complexity (Asfc)", y = "Anisotropy (epLsar)") +
  
           # The qualitative 'Set2' palette of RColorBrewer is colorblind friendly
           scale_color_brewer(palette = 'Set2') +
  
           # Wrap around Specimen (i.e. 1 subplot per specimen)
           facet_wrap(~ Specimen) +
  
           # Choose a light theme
           theme_classic()

# Print plot
print(Sp_p_bi)
```


## Facetting around Position
```{r}
# set up plot
Pos_p_bi <- ggplot(sharks_nmp0_20, aes(x = Asfc, y = epLsar)) +
            geom_point(mapping = aes(color = .data[[grp_colors]], shape = .data[[grp_shapes]]), size = 4) +
            labs(x = "Complexity (Asfc)", y = "Anisotropy (epLsar)") +
            scale_color_brewer(palette = 'Set2') +
            facet_wrap(~ Position) +
            theme_classic()

# Print plot
print(Pos_p_bi)
```


## Save plots
```{r}
ggexport(plotlist = list(Sp_p_bi, Pos_p_bi), filename = paste0(dir_out, "/DMTA-Ctenacanths_epLsar-Asfc.pdf"))
```


---


# PCA
## Prepare data and select parameters
```{r}
# Remove rows with NA (complete cases)
data_pca <- na.omit(sharks_nmp0_20)

# Convert grouping variables into factor()
data_pca[["Specimen"]] <- factor(data_pca[["Specimen"]])
data_pca[["Tooth"]] <- factor(data_pca[["Tooth"]])
data_pca[["Position"]] <- factor(data_pca[["Position"]])
str(data_pca)

# Select parameters to use in the PCA, based on previous plots
pca_params <- c("Sq", "Vmc", "Sal", "Sdr", "Str", 
                "First.direction", "Mean.density.of.furrows", "Mean.depth.of.furrows", 
                "Asfc", "epLsar", "HAsfc9")
```

## Run PCAs
### PCA on all surfaces
```{r}
pca_all <- prcomp(data_pca[ , pca_params], scale. = TRUE) 
```

### PCA on Specimen CC 
```{r}
# Filter data on Specimen CC
data_pca_tooth <- filter(data_pca, Specimen == "CC")
str(data_pca_tooth)

# PCA 
pca_cc <- prcomp(data_pca_tooth[ , pca_params], scale. = TRUE)
```


## Plots
### Eigenvalues
#### On all surfaces
```{r}
pca_all_eig <- fviz_eig(pca_all, addlabels = TRUE, ggtheme = theme_classic(), 
                        title = "PCA all surfaces - Eigenvalues")
print(pca_all_eig)
```

#### On Specimen CC
```{r}
pca_cc_eig <- fviz_eig(pca_cc, addlabels = TRUE, ggtheme = theme_classic(), 
                       title = "PCA CC - Tooth - Eigenvalues")
print(pca_cc_eig)
```


### Biplots
#### Plotting function
```{r}
custom_pca_biplot <- function(dat, datpca, pc = c(1, 2), geom.pt = "point", col.pt, mean.pt = FALSE, 
                              col.pal = brewer.pal(3, "Set2")[1:2], pt.size = 3, pt.shape = 19, 
                              elli = TRUE, elli.type = "convex", repel.lab = TRUE, 
                              col.variable = "black", main.title){
  
  # Define plotting
  p_out <- fviz_pca_biplot(dat, axes = pc, 
                           geom.ind = geom.pt, col.ind = datpca[[col.pt]], mean.point = mean.pt,
                           palette = col.pal, pointsize = pt.size, pointshape = pt.shape,
                           addEllipses = elli, ellipse.type = elli.type,  
                           repel = repel.lab, col.var = col.variable, 
                           legend.title = col.pt, title = main.title)

  # Return plotting object
  return(p_out)
}
```

#### On all surfaces with grouping from Specimen (CC vs. MM)
```{r}
# Biplot of PC1&2
pca_spec_12 <- custom_pca_biplot(pca_all, datpca = data_pca, pc = c(1, 2), col.pt = "Specimen",
                                 main.title = "PCA all surfaces - Specimen - PC1&2")
print(pca_spec_12)

# Biplot of PC1&3
pca_spec_13 <- custom_pca_biplot(pca_all, datpca = data_pca, pc = c(1, 3), col.pt = "Specimen",
                                 main.title = "PCA all surfaces - Specimen - PC1&3")
print(pca_spec_13)
```

#### On all surfaces with grouping from Position (bottom vs. top)
```{r}
# Biplot of PC1&2
pca_pos_12 <- custom_pca_biplot(pca_all, datpca = data_pca, pc = c(1, 2), col.pt = "Position",
                                main.title = "PCA all surfaces - Position - PC1&2")
print(pca_pos_12)

# Biplot of PC1&3
pca_pos_13 <- custom_pca_biplot(pca_all, datpca = data_pca, pc = c(1, 3), col.pt = "Position",
                                main.title = "PCA all surfaces - Position - PC1&3")
print(pca_pos_13)
```

#### On Specimen CC with grouping from Tooth 

UNFINISHED!!!

```{r}
# Biplot of PC1&2
pca_tooth_12 <- fviz_pca_biplot(pca_cc, axes = c(1, 2), 
                                geom.ind = "point", col.ind = data_pca_tooth$Tooth, 
                                fill.ind = data_pca_tooth$Tooth, mean.point = FALSE, 
                                palette = brewer.pal(7, "Set2"), pointsize = 3, pointshape = 21,
                                addEllipses = TRUE, ellipse.type = "convex",  
                                repel = TRUE, col.var = "black", 
                                legend.title = "Specimen", title = "PCA CC - Tooth - PC1&2")
print(pca_tooth_12)

pca_tooth_12 <- custom_pca_biplot(pca_cc, datpca = data_pca_tooth, pc = c(1, 2), col.pt = "Tooth",
                                  col.pal = brewer.pal(7, "Set2"), pt.shape = 21,
                                  main.title = "PCA all surfaces - Position - PC1&2")
print(pca_tooth_12)

# Biplot of PC1&3
pca_tooth_13 <- fviz_pca_biplot(pca_cc, axes = c(1, 3), 
                                geom.ind = "point", col.ind = data_pca_tooth$Tooth, 
                                fill.ind = data_pca_tooth$Tooth, mean.point = FALSE, 
                                palette = brewer.pal(7, "Set2"), pointsize = 3, pointshape = 21,
                                addEllipses = TRUE, ellipse.type = "convex",  
                                repel = TRUE, col.var = "black", 
                                legend.title = "Specimen", title = "PCA CC - Tooth - PC1&3")
print(pca_tooth_13)
```


### Save plots
```{r}
ggexport(plotlist = list(pca_all_eig, pca_spec_12, pca_spec_13, pca_pos_12, pca_pos_13,
                         pca_cc_eig, pca_tooth_12, pca_tooth_13), 
         filename = paste0(dir_out, "/DMTA-Ctenacanths_PCA.pdf"))
```


---


# sessionInfo()

```{r}
sessionInfo()
```


---


# Cite R packages used

```{r, echo = FALSE}
pkgs_cite <- cite_packages(pkgs = c(pack_to_load, "base"), output = "table", include.RStudio = TRUE, 
                           out.dir = "analysis/scripts", bib.file = "Sharks_3_Plots")
knitr::kable(pkgs_cite)
```


## References

